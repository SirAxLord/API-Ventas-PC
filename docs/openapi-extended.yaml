openapi: 3.0.3
info:
  title: API Ventas y Servicios (v1) - Extended Roles Spec
  version: 1.0.0
  description: |
    Extensión del contrato incorporando roles y endpoints adicionales.
    Roles:
      - admin: CRUD completo productos/servicios y gestión de usuarios
      - customer: lectura pública + registro/login + perfil propio
      - guest: lectura pública sin token
servers:
  - url: http://localhost:8000/v1
security:
  - bearerAuth: []
paths:
  /auth/register:
    post:
      summary: Registrar nuevo usuario (rol customer)
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name,email,password]
              properties:
                name: { type: string }
                email: { type: string, format: email }
                password: { type: string, minLength: 6 }
      responses:
        '201':
          description: Usuario creado + token
          content:
            application/json:
              schema:
                type: object
                properties:
                  token: { type: string }
                  user: { $ref: '#/components/schemas/User' }
        '422': { $ref: '#/components/responses/ValidationError' }
  /auth/me:
    get:
      summary: Perfil autenticado
      tags: [Auth]
      security: [ { bearerAuth: [] } ]
      responses:
        '200':
          description: Datos usuario
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '401': { $ref: '#/components/responses/Unauthorized' }
  /users:
    get:
      summary: Listar usuarios (admin)
      tags: [Usuarios]
      security: [ { bearerAuth: [] } ]
      x-roles: [admin]
      parameters:
        - in: query
          name: search
          schema: { type: string }
      responses:
        '200':
          description: Lista usuarios
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items: { $ref: '#/components/schemas/User' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
  /users/{id}/role:
    patch:
      summary: Actualizar rol (admin)
      tags: [Usuarios]
      security: [ { bearerAuth: [] } ]
      x-roles: [admin]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [role]
              properties:
                role: { type: string, enum: [admin, customer] }
      responses:
        '200':
          description: Rol actualizado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  responses:
    Unauthorized:
      description: No autenticado
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                properties:
                  message: { type: string }
                  status: { type: integer }
    ValidationError:
      description: Error validación
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                properties:
                  message: { type: string }
                  status: { type: integer }
                  details:
                    type: object
                    additionalProperties: true
    Forbidden:
      description: Rol insuficiente
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                properties:
                  message: { type: string }
                  status: { type: integer }
    NotFound:
      description: Recurso no encontrado
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                properties:
                  message: { type: string }
                  status: { type: integer }
  schemas:
    User:
      type: object
      properties:
        id: { type: integer }
        name: { type: string }
        email: { type: string }
        role: { type: string, enum: [admin, customer] }
